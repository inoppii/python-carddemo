# COBIL00C 詳細設計書

## 1. 概要

`COBIL00C` は、オンラインでアカウントの引き落とし（支払い）を処理する CICS プログラムです。指定されたアカウント ID の現在の残高を確認し、全額支払いを実行して、その内容を取引履歴ファイル (`TRANSACT`) に記録します。

## 2. プログラム情報

- **プログラム ID**: `COBIL00C`
- **作成者**: AWS
- **タイプ**: CICS COBOL, VSAM, BMS
- **トランザクション ID**: `CB00`
- **マップセット**: `COBIL00`
- **マップ名**: `COBIL0A`

## 3. 入出力定義

### 3.1. 画面 (BMS)

- **主要フィールド**:
  - `ACTIDINI`: 支払い対象のアカウント ID。
  - `CURBALI`: 現在の残高（表示のみ）。
  - `CONFIRMI`: 支払い実行の確認フラグ ('Y'/'N')。

### 3.2. VSAM ファイル

- **ACCTDAT**: アカウント残高の更新対象。 `READ UPDATE`, `REWRITE`。
- **CXACAIX**: アカウント ID からカード番号を取得するための Alternate Index。
- **TRANSACT**: 支払い履歴を新規レコードとして追加。 `STARTBR`, `READPREV` (ID 採番用), `WRITE`。

## 4. 処理ロジック詳細

### 4.1. アカウント確認 (`PROCESS-ENTER-KEY`)

1. **残高照会**: `ACCTDAT` を読み込み、現在の残高を取得。
2. **残高チェック**: 残高が 0 以下の場合は「支払い対象がありません」メッセージを表示。

### 4.2. 支払い実行

1. **確認入力**: `CONFIRMI` が 'Y' の場合のみ処理を続行。
2. **カード番号取得**: `CXACAIX` を引き、対象アカウントに関連付けられたカード番号を取得。
3. **取引 ID 採番**: `TRANSACT` ファイルの末尾から最新の ID を取得し、+1 した値を新しい `TRAN-ID` とする。
4. **取引記録 (`WRITE-TRANSACT-FILE`)**:
    - `TRAN-TYPE-CD = '02'` (支払い)、`TRAN-DESC = 'BILL PAYMENT - ONLINE'` をセット。
    - アカウントの現在残高を支払い額として記録。
5. **残高更新 (`UPDATE-ACCTDAT-FILE`)**:
    - アカウントの `ACCT-CUR-BAL` を 0 に更新する（支払額を残高から差し引く）。

## 5. エラーハンドリング

- アカウント ID 不在のエラー。
- 支払い確認なしでの Enter 押下に対する警告。
- 二重支払い防止などの整合性チェック。

## 6. 特記事項

- 本プログラムは「全額支払い」を前提としており、一部支払いのロジックは含まれていない。
- リアルタイムで `TRANSACT` ファイルに書き込むことで、後続のレポート処理やバッチ処理との整合性を確保している。
