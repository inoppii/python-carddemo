# COUSR02C 詳細設計書

## 1. 概要

`COUSR02C` は、既存ユーザーの情報を更新するための CICS オンラインプログラムです。
ユーザー ID を指定して現在の情報を表示し、変更があった項目のみを `USRSEC` ファイルに反映します。排他制御のために更新用読み込み (`READ UPDATE`) を行います。

## 2. プログラム情報

- **プログラム ID**: `COUSR02C`
- **作成者**: AWS
- **タイプ**: CICS COBOL, VSAM, BMS
- **トランザクション ID**: `CU02`
- **マップセット**: `COUSR02`
- **マップ名**: `COUSR2A`

## 3. 入出力定義

### 3.1. 画面 (BMS)

- **マップセット**: `COUSR02`
- **主要フィールド**:
  - `USRIDINI`: 検索・更新対象のユーザー ID。
  - `FNAMEI` / `LNAMEI`: 姓名。
  - `PASSWDI`: パスワード。
  - `USRTYPEI`: ユーザータイプ。

### 3.2. VSAM ファイル

- **USRSEC**: ユーザーセキュリティファイル。`READ UPDATE`, `REWRITE` 処理を実行。

## 4. 処理ロジック詳細

### 4.1. データ取得 (`PROCESS-ENTER-KEY`)

- 指定されたユーザー ID で `USRSEC` を `READ`。
- レコードが存在すれば、取得した情報を画面に反映。
- 存在しない場合は「User ID NOT found」を表示。

### 4.2. 更新処理 (`UPDATE-USER-INFO`)

1. **入力チェック**: 姓名、パスワード、タイプが空でないか確認。
2. **変更検知**: 画面上の値がファイル上の元の値から変更されているかフラグ (`USR-MODIFIED`) で判定。
3. **ロックと更新 (`UPDATE-USER-SEC-FILE`)**:
    - `READ UPDATE` でレコードをロック。
    - 変更された項目をレコードにセット。
    - `REWRITE` で書き込み。
4. **結果表示**: 更新成功メッセージを表示。変更がない場合は「Please modify to update」と通知。

### 4.3. 画面遷移

- **F3 (PF3)**: 更新を保存せずに（または保存して）前の画面へ戻る。
- **F5 (PF5)**: 明示的な更新実行ボタンとしての役割（`UPDATE-USER-INFO` を実行）。
- **F12 (PF12)**: 管理メニュー (`COADM01C`) へ戻る。

## 5. エラーハンドリング

- 更新読み込み中に他者がレコードを削除・変更した場合などの例外ハンドリング。
- 存在しないユーザー ID に対する更新操作の禁止。

## 6. 特記事項

- `COUSR00C` (一覧) から遷移してきた場合は、自動的に対象のユーザー情報がロードされる。
- 楽観的ロックではなく、CICS の `READ UPDATE` による悲観的ロックに近い動作で更新トランザクションが管理されている。
