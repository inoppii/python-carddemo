# COACTUPC 詳細設計書

## 1. 概要

`COACTUPC` は、アカウント (口座) 情報および関連する顧客情報の詳細照会と更新を行う CICS オンラインプログラムです。`COACTVWC` と同様の照会機能に加え、画面上で変更された項目を検知し、VSAM ファイル (`ACCTDAT`, `CUSTDAT`) を更新する機能を持ちます。

## 2. プログラム情報

- **プログラム ID**: `COACTUPC`
- **作成者**: AWS
- **タイプ**: CICS COBOL, VSAM, BMS
- **トランザクション ID**: `CAUP`
- **マップセット**: `COACTUP`
- **マップ名**: `CACTUPA`

## 3. 入出力定義

### 3.1. 画面 (BMS)

- **マップセット**: `COACTUP`
- **主要フィールド**:
  - 入力（検索用）: `ACCTSIDI` (Account ID)
  - 入出力（更新用）:
    - アカウント情報: `ACSTTUS` (Status), `ACRDLIM` (Limit), `ACASHCRE` (Cash Limit) 等。
    - 顧客情報: `ACSFNAM` (First Name), `ACSLNAM` (Last Name), `ACSADL1` (Address) 等、多数のフィールドが更新可能。

### 3.2. VSAM ファイル

- **ACCTDAT**: アカウント情報の更新対象。`READ UPDATE` でロックして更新。
- **CUSTDAT**: 顧客情報の更新対象。同様にロックして更新。
- **CXACAIX** (Path): アカウント ID から顧客 ID を特定するために参照。

### 3.3. COMMAREA

- **内部構造**:
  - `ACUP-OLD-DETAILS`: 更新前のデータを保持（楽観的ロックチェック用）。
  - `ACUP-NEW-DETAILS`: 画面からの入力値を保持。

## 4. 処理ロジック詳細

### 4.1. 検索・詳細表示 (PROCESS-INPUTS -> CDEMO-PGM-REENTER)

- `COACTVWC` と同様のロジックでアカウントおよび顧客情報を取得。
- 取得したデータを画面に表示すると同時に、COMMAREA の `ACUP-OLD-DETAILS` に保存する（後に変更検知で使用）。

### 4.2. 更新前検証 (PROCESS-INPUTS)

- ユーザーが値を変更して Enter を押下した際、以下の検証を行う。

1. **入力チェック**: 必須項目、数値形式、日付の妥当性などをチェック。
2. **変更検知**: 画面入力値 (`ACUP-NEW`) と保存しておいた元データ (`ACUP-OLD`) を比較。
   - 変更がない場合、「No change detected」と表示。

### 4.3. 更新処理 (PROCESS-UPDATE)

- 変更が検知され、入力が妥当な場合、更新処理を実行。

1. **再読み込みとロック (`READ FOR UPDATE`)**:
   - `ACCTDAT` および `CUSTDAT` を `UPDATE` オプション付きで読み込む。
2. **並行更新チェック (楽観的ロック)**:
   - 再読み込みしたレコードの内容と、`ACUP-OLD` (前回表示時のデータ) を比較。
   - 他のユーザーによって既に書き換えられていた場合、「Record changed by some one else」とエラーを表示し、更新を中断。
3. **書き換え (`REWRITE`)**:
   - 競合がなければ、新しい値で `REWRITE` を実行。
   - アカウント情報と顧客情報の両方が更新対象となり得る。

## 5. エラーハンドリング

- **排他制御エラー**: 更新時の競合検知により、データの整合性を保護。
- **ファイルエラー**: VSAM アクセス失敗時のハンドリング。
- **入力エラー**: 多岐にわたる項目（SSN, 電話番号, 日付等）のフォーマットチェックを実装。

## 6. 特記事項

- **顧客情報の同時更新**: 本プログラムは「アカウント更新」という名前だが、実際には紐づく「顧客情報」の更新機能も内包している（住所変更など）。
- **楽観的ロック**: CICS の会話型処理ではなく、擬似会話型 (`PSEUDO-CONVERSATIONAL`) であるため、COMMAREA を利用した独自の楽観的ロックロジックを実装している。
