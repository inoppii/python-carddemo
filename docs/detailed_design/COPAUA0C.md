# COPAUA0C 詳細設計書

## 1. 概要

`COPAUA0C` は、Credit Card Authorization (承認機能) の中核となる CICS オンラインプログラムです。IBM MQ を介して承認リクエスト (Request) を受信し、顧客およびカードの検証、与信枠の確認を行い、承認 (Approve) または拒否 (Decline) の判定を下します。結果は IMS データベースに記録され、MQ を介して応答 (Reply) が返却されます。

## 2. プログラム情報

- **プログラム ID**: `COPAUA0C`
- **作成者**: AWS / SOUMA GHOSH
- **タイプ**: CICS COBOL, IMS, MQ
- **トランザクション ID**: `CP00`

## 3. 入出力定義

### 3.1. MQ メッセージ (入力)

- **キュー名**: `MQTM-QNAME` (トリガーデータより取得)
- **フォーマット**: カンマ区切りテキスト (CSV形式)
- **主要項目**:
  - カード番号
  - 取引金額
  - 有効期限
  - 加盟店情報
  - トランザクション ID 等

### 3.2. MQ メッセージ (出力)

- **キュー名**: 入力メッセージの `ReplyToQ` ヘッダーより取得
- **フォーマット**: カンマ区切りテキスト
- **主要項目**:
  - カード番号
  - トランザクション ID
  - 承認レスポンスコード (`00`: 承認, `05`: 拒否)
  - 拒否理由コード (`0000`: 承認, `3100`: 無効なカード, `4100`: 残高不足 等)
  - 承認金額

### 3.3. データベース / ファイル

- **VSAM**:
  - `CARDDAT` (KSDS): カード情報マスタ。インデックス `CARDAIX` (AcctIDパス) も使用される可能性あり。
  - `CCXREF` (KSDS): カード番号とアカウント ID / 顧客 ID のクロスリファレンス。
  - `ACCTDAT` (KSDS): アカウント (口座) マスタ。
  - `CUSTDAT` (KSDS): 顧客マスタ。
- **IMS**:
  - `PSBPAUTB`: 承認トランザクション履歴データベース。
    - セグメント `PAUTSUM0` (ルート): アカウント単位のサマリー。
    - セグメント `PAUTDTL1` (子供): 個別の承認明細。

## 4. 処理ロジック詳細

### 4.1. 初期化処理 (1000-INITIALIZE)

- CICS `RETRIEVE` コマンドで起動パラメータ (MQ トリガーデータ) を取得。
- リクエストキュー名を特定し、`MQOPEN` でキューをオープン (共有入力モード)。
- IMS PSB (`PSBPAUTB`) をスケジュール (`DLI SCHD`)。すでにスケジュールされている場合は再スケジュールを行う。

### 4.2. メインループ (2000-MAIN-PROCESS)

設定された処理上限回数 (`WS-REQSTS-PROCESS-LIMIT`: 500回) またはメッセージがなくなるまで以下を繰り返す。

1. **メッセージ受信 (3100-READ-REQUEST-MQ)**:
   - `MQGET` でメッセージを取得。
   - 待機時間 (`WS-WAIT-INTERVAL`) は 5秒 (5000ms)。
   - 取得失敗時、メッセージなし (`MQRC-NO-MSG-AVAILABLE`) ならループ終了。それ以外のエラーはログ出力。
2. **メッセージ解析 (2100-EXTRACT-REQUEST-MSG)**:
   - `UNSTRING` コマンドで CSV 形式のメッセージを各項目に分解。
3. **承認判定処理 (5000-PROCESS-AUTH)**:
   - **クロスリファレンス確認 (5100-READ-XREF-RECORD)**:
     - 入力されたカード番号で `CCXREF` を検索。
     - 存在しない場合、エラーフラグ設定 (`CARD-NFOUND-XREF`)。
   - **マスタ検証 (5100, 5200, 5300)**:
     - `CCXREF` から取得した `ACCT-ID`, `CUST-ID` でそれぞれ `ACCTDAT`, `CUSTDAT` を検索。
     - 存在しない場合、エラーフラグ設定。
   - **IMS 与信枠確認 (5500-READ-AUTH-SUMMRY)**:
     - `ACCT-ID` をキーに IMS データベース (`PAUTSUM0`) を検索。
     - 既存の利用残高、承認済み金額を取得。
   - **判定ロジック (6000-MAKE-DECISION)**:
     - 利用可能額を計算。
       - IMS データがある場合: `利用可能額 = 与信限度額 - 現在の残高`
       - IMS データがない場合: アカウントマスタの `ACCT-CREDIT-LIMIT - ACCT-CURR-BAL` を使用。
     - `取引金額 > 利用可能額` の場合、**残高不足 (Insufficient Funds)** として拒否 (`DECLINE-AUTH`)。
     - マスタ検索でエラーがあった場合も拒否。
     - 判定結果に基づき、レスポンスコード (`00`/`05`) と理由コードを設定。
   - **応答送信 (7100-SEND-RESPONSE)**:
     - 判定結果を CSV 形式に整形し、`MQPUT1` で応答キューへ送信。
     - `CorrelId` にはリクエストの `MsgId` (または `CorrelId`) を設定して紐付けを行う。
   - **DB 更新 (8000-WRITE-AUTH-TO-DB)**:
     - **サマリー更新/作成 (8400-UPDATE-SUMMARY)**:
       - 既に IMS ルートセグメント (`PAUTSUM0`) が存在する場合は、承認/拒否件数および金額を加算して `REPL` (更新)。
       - 存在しない場合は、新規に `ISRT` (挿入)。
     - **明細作成 (8500-INSERT-AUTH)**:
       - 今回の取引内容を IMS 子セグメント (`PAUTDTL1`) として `ISRT` (挿入)。

4. **コミット (Syncpoint)**:
   - 1件処理ごとに `CICS SYNCPOINT` を発行し、MQ および DB の変更を確定。
   - IMS PSB は 1件ごとに `SCHD` されている状態かを確認し、必要ならリリース・再スケジュール (ループ処理内のフラグ管理による)。

### 4.3. 終了処理 (9000-TERMINATE)

- MQ キューをクローズ (`MQCLOSE`)。
- IMS PSB を終了 (`DLI TERM`)。
- CICS タスクを終了 (`CICS RETURN`)。

## 5. エラーハンドリング

- **MQ エラー**: オープン、GET、PUT 失敗時は `ERR-CRITICAL` としてログ出力 (`9500-LOG-ERROR`)。
- **IMS エラー**: スケジュール、検索、更新失敗時は `ERR-CRTICAL` または `ERR-WARNING` としてログ出力。
- **VSAM エラー**: レコードが見つからない (`NOTFND`) 場合は業務エラーとして扱い、承認拒否の理由とする。I/O エラーはログ出力。
- **共通エラーログ**: `9500-LOG-ERROR` にて時刻、エラーコード、メッセージをコンソール等に出力 (実装依存)。

## 6. 特記事項

- **IMS と VSAM の併用**: 与信枠管理のマスターデータは VSAM (`ACCTDAT`) にあるが、リアルタイムの承認累積データは IMS (`PAUTSUM0`) で管理されている。
- **同時実効性**: MQ トリガーによって起動されるため、複数のインスタンスが並行して動作する可能性がある。IMS および VSAM のロック機構により整合性が保たれる。
- **日付処理**: Y2K 対応 (年2桁処理) が見られる箇所がある (`CURRENT-YEAR(3:2)` 等)。
