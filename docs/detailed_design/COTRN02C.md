# COTRN02C 詳細設計書

## 1. 概要

`COTRN02C` は、新しい取引データを手動で追加するための CICS プログラムです。アカウント ID またはカード番号のいずれかを入力することで相手方の情報を自動取得し、取引の詳細（カテゴリ、金額、日時、加盟店）をバリデーションした上で `TRANSACT` ファイルに書き込みます。

## 2. プログラム情報

- **プログラム ID**: `COTRN02C`
- **作成者**: AWS
- **タイプ**: CICS COBOL, VSAM, BMS, Sub-program call
- **トランザクション ID**: `CT02`
- **マップセット**: `COTRN02`
- **マップ名**: `COTRN2A`

## 3. 入出力定義

### 3.1. 画面 (BMS)

- **主要キー項目**: `ACTIDINI` (アカウント ID) または `CARDNINI` (カード番号)。
- **データ入力項目**: 取引タイプ、カテゴリ、ソース、説明、金額、発生日、処理日、加盟店情報。

### 3.2. VSAM ファイル

- **TRANSACT**: 新規レコードの追加。 `WRITE`。採番のために `STARTBR`/`READPREV` を使用。
- **ACCTDAT**: アカウント存在確認。
- **CCXREF / CXACAIX**: アカウント ID とカード番号の相互引き当て用。

## 4. 処理ロジック詳細

### 4.1. 入力補完とチェック (`VALIDATE-INPUT-KEY-FIELDS`)

- アカウント ID 入力時: `CXACAIX` を参照してカード番号を補完。
- カード番号入力時: `CCXREF` を参照してアカウント ID を補完。

### 4.2. データバリデーション (`VALIDATE-INPUT-DATA-FIELDS`)

- 各項目の必須チェック。
- 金額形式 (`-99999999.99`) のチェック。
- 日付形式 (`YYYY-MM-DD`) の妥当性をサブプログラム `CSUTLDTC` を呼び出して確認。

### 4.3. 登録処理 (`ADD-TRANSACTION`)

1. **ID 採番**: `TRANSACT` ファイルの末尾を読み取り、最大の ID に +1 して新 ID を生成。
2. **書き込み**: `WRITE` コマンドで新規レコードを作成。
3. **確認メッセージ**: 成功時に生成された取引 ID を表示。

### 4.4. 便利機能 (`COPY-LAST-TRAN-DATA`)

- **PF5**: 直前に登録（または参照）された取引データをテンプレートとして現在の画面にコピーし、再入力を省く。

## 5. エラーハンドリング

- アカウント・カード番号の不在エラー。
- 重複キーエラー (`DUPREC`) のハンドリング。
- サブプログラムからの日付エラー返却。

## 6. 特記事項

- オンラインでの単発取引発生をシミュレーションするための強力な入力チェック機能を持つ。
- `CSUTLDTC` という共通日付バリデーションモジュールに依存している。
