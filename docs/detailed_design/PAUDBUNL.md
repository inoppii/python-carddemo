# PAUDBUNL 詳細設計書

## 1. 概要

`PAUDBUNL` は、IMS データベース (`PSBPAUTB`) 上の承認データを読み込み、後続の処理やバックアップ、再ロード (`PAUDBLOD`) のためにフラットファイル (`OPFILE1`, `OPFILE2`) へアンロードするバッチプログラムです。`DBUNLDGS` と似ていますが、こちらは GSAM ではなく通常の順編成ファイルに出力する点が異なります。

## 2. プログラム情報

- **プログラム ID**: `PAUDBUNL`
- **作成者**: AWS
- **タイプ**: COBOL Batch, IMS (DLI)
- **機能**: Unload Authorization Data to Flat Files

## 3. 入出力定義

### 3.1. IMS データベース (入力)

- **PSB**: `PSBPAUTB`
- **セグメント**:
  - `PAUTSUM0` (ルート): アカウント単位の承認サマリー。
  - `PAUTDTL1` (子供): 個別の承認明細。

### 3.2. 出力ファイル

- **OPFILE1**: ルートセグメント出力用ファイル。
  - レコード長: 100 byte
- **OPFILE2**: 子セグメント出力用ファイル。
  - レコード長: Root-Key + Child-Data

## 4. 処理ロジック詳細

### 4.1. 初期化処理 (1000-INITIALIZE)

- 出力ファイル (`OPFILE1`, `OPFILE2`) をオープン。
- 開始メッセージ出力。

### 4.2. メインループ (2000-FIND-NEXT-AUTH-SUMMARY)

1. **ルート読み込み**:
   - `DLI GN` で `PAUTSUM0` を取得。
   - データ終了 (`GB`) まで繰り返す。
2. **ルート出力**:
   - `WRITE OPFILE1` でルートセグメントの内容をファイル1へ書き出す。
3. **明細ループ (3000-FIND-NEXT-AUTH-DTL)**:
   - `DLI GNP` で子セグメント (`PAUTDTL1`) を取得。
   - `WRITE OPFILE2` で子セグメントの内容をファイル2へ書き出す。
     - この際、どの親に紐付くか分かるように、親キー (`ROOT-SEG-KEY` / `PA-ACCT-ID`) をレコードの付加情報として先頭等に書き込んでいる。

### 4.3. 終了処理 (4000-FILE-CLOSE)

- 出力ファイルのクローズ。
- 処理件数統計の表示。

## 5. エラーハンドリング

- **DLI エラー**: データベース読み込み (`GN`, `GNP`) 失敗時、ステータスコードをログに出力し、異常終了 (`9999-ABEND`) する。
- **ファイルエラー**: ファイル書き込み (`WRITE`) エラー時なども異常終了扱いとする。

## 6. 特記事項

- **ファイル形式**: 通常の QSAM ファイルを使用しているため、JCL での取り扱いが容易であり、ソートや他システムへの転送に適している。
- **再ロード対応**: 出力形式は `PAUDBLOD` の入力形式と対になっており、アンロード -> (DB初期化) -> ロード というサイクルが可能。
