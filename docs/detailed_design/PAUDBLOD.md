# PAUDBLOD 詳細設計書

## 1. 概要

`PAUDBLOD` は、フラットファイル (`INFILE1`, `INFILE2`) からデータを読み込み、IMS データベース (`PSBPAUTB`) にロード（再構築または初期ロード）するバッチプログラムです。通常、バックアップからのリストアや、`PAUDBUNL` でアンロードされたデータの再ロード、テストデータの投入などに使用されます。

## 2. プログラム情報

- **プログラム ID**: `PAUDBLOD`
- **作成者**: AWS
- **タイプ**: COBOL Batch, IMS (DLI)
- **機能**: Load Authorization Data (DB Initial Load / Reload)

## 3. 入出力定義

### 3.1. 入力ファイル

- **INFILE1**: ルートセグメント (`PAUTSUM0`) 用の順編成ファイル。
  - レコード長: 100 byte
- **INFILE2**: 子セグメント (`PAUTDTL1`) 用の順編成ファイル。
  - レコード長: 可変長または固定長 (Root-Key + Child-Data)

### 3.2. IMS データベース (出力)

- **PSB**: `PSBPAUTB`
- **セグメント**:
  - `PAUTSUM0` (ルート): `ISRT` される。
  - `PAUTDTL1` (子供): ルートの下に `ISRT` される。

## 4. 処理ロジック詳細

### 4.1. 初期化処理 (1000-INITIALIZE)

- 入力ファイル (`INFILE1`, `INFILE2`) をオープン。
- 処理開始のログ出力。

### 4.2. ルートセグメント処理 (2000-READ-ROOT-SEG-FILE)

1. **ファイル読み込み**:
   - `INFILE1` を読み込む。終了 (`10`) するまでループ。
2. **ルート挿入 (2100-INSERT-ROOT-SEG)**:
   - 読み込んだレコードを `PENDING-AUTH-SUMMARY` レイアウトに転送。
   - `DLI ISRT` コマンドで IMS データベースに挿入。
   - ステータス `II` (Already Exists) の場合は「登録済み」としてスキップ（またはエラーログ）。

### 4.3. 子セグメント処理 (3000-READ-CHILD-SEG-FILE)

1. **ファイル読み込み**:
   - `INFILE2` を読み込む。終了するまでループ。
   - 入力レコードは「親キー (`ROOT-SEG-KEY`) ＋ 子データ」の形式になっている。
2. **親の特定 (3100-INSERT-CHILD-SEG)**:
   - レコード内の親キーを使って、まず対象の親セグメントを `DLI GU` (Get Unique) で検索・特定する。
   - これにより、カレントポジションを正しい親セグメントに移動させる。
3. **子挿入 (3200-INSERT-IMS-CALL)**:
   - カレントの親の下に、読み込んだ子データを `DLI ISRT` で挿入する。

### 4.4. 終了処理 (4000-FILE-CLOSE)

- ファイルクローズ。
- 終了メッセージ出力。

## 5. エラーハンドリング

- **DLI エラー**: 挿入失敗 (`ISRT` error) や 親検索失敗 (`GU` error) の場合、ステータスコードを表示して異常終了 (`9999-ABEND`) する。
- **ファイルエラー**: ファイルオープンや読み込みエラー時も異常終了。

## 6. 特記事項

- **2ファイル構成**: 親と子のデータが別の物理ファイルから供給される構造になっているため、親データのロード完了後に子データのロードを行う 2 パス方式、あるいは並行処理的なロジックになっている（コード上は `2000` ループ後に `3000` ループを実行するシーケンシャルな流れ）。
- **データ整合性**: 子データをロードする際、対応する親データが既に IMS 上に存在しなければならない（`GU` で親を確立するため）。
