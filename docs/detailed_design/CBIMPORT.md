# CBIMPORT 詳細設計書

## 1. 概要

`CBIMPORT` は、`CBEXPORT` によって生成された統合エクスポートファイルを読み込み、レコード種別に基づいて各マスタファイル（顧客、アカウント、カード等）へデータを分解・配布するバッチプログラムです。

## 2. プログラム情報

- **プログラム ID**: `CBIMPORT`
- **作成者**: CARDDEMO TEAM
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: `IMPORT.jcl` (想定)

## 3. 入出力定義

### 3.1. 入力ファイル

- **EXPORT-INPUT**: 拠点移行用エクスポートファイル (`EXPFILE`)。固定長 500 バイト、レコード種別コードを含む。

### 3.2. 出力ファイル

- **CUSTOMER-OUTPUT**: 顧客マスタデータ。
- **ACCOUNT-OUTPUT**: アカウントマスタデータ。
- **XREF-OUTPUT**: クロスリファレンスマスタデータ。
- **TRANSACTION-OUTPUT**: 取引履歴データ。
- **CARD-OUTPUT**: カードマスタデータ。
- **ERROR-OUTPUT**: 未知のレコード種別やエラーが発生したレコードのログ。

## 4. 処理ロジック詳細

### 4.1. レコード分解ロジック

入力ファイルを 1 レコードずつ読み込み、`EXPORT-REC-TYPE` の値に応じて条件分岐 (`EVALUATE`) を行います。

- `C` → 顧客レコードとして処理 (`2300-PROCESS-CUSTOMER-RECORD`)
- `A` → アカウントレコードとして処理 (`2400-PROCESS-ACCOUNT-RECORD`)
- `X` → クロスリファレンスレコードとして処理 (`2500-PROCESS-XREF-RECORD`)
- `T` → 取引レコードとして処理 (`2600-PROCESS-TRAN-RECORD`)
- `D` → カードレコードとして処理 (`2650-PROCESS-CARD-RECORD`)

### 4.2. エラー処理

定義されていないレコード種別が検出された場合、`2700-PROCESS-UNKNOWN-RECORD` を呼び出してエラーログ (`ERROR-OUTPUT`) に出力し、スキップします。

### 4.3. 統計レポート

処理完了後、各カテゴリごとのインポート件数、エラー件数、未知のレコード件数を標準出力に表示し、インポート結果の検証を行います。

## 5. エラーハンドリング

- ファイルオープンや読込エラー等の致命的な障害時は、エラー詳細を表示してアベンド (`CEE3ABD`) します。

## 6. 特記事項

- 入力ファイルはシーケンス番号でソートされていることを前提としています。
- データの整合性検証 (`3000-VALIDATE-IMPORT`) のためのプレースホルダが含まれており、将来的な拡張性が考慮されています。
