# COTRTUPC 詳細設計書

## 1. 概要

- **プログラムID**: COTRTUPC
- **論理層**: Business Logic
- **機能**: トランザクションタイプの詳細表示、新規追加、更新、および削除を行います。
- **特徴**: 単一レコードに対する CRUD 操作を完結させます。

## 2. 入出力

### 入力

- **BMSマップ**: `ctrtupa` (Mapset: `COTRTUP`) ※注: ソース内のリテラルは `CTRTUPA` だがファイル名は `COTRTUP`
- **Commarea**:
  - 遷移元 (`COTRTLIC` 等) から渡された処理対象の `TR_TYPE` キー
  - 処理モード (表示、追加、更新、削除)

### 出力

- **BMSマップ**: `CTRTUPA`
  - 詳細データの表示
  - 処理結果メッセージ (成功、失敗、検証エラー)
- **データベース更新**: `TRANSACTION_TYPE` テーブルへの変更

## 3. 外部仕様

### 画面

- **マップセット**: `COTRTUP`
- **マップ**: `CTRTUPA`
- **機能**:
  - 詳細表示: トランザクションタイプコード、説明
  - PFキー:
    - `F3`: 終了/戻る
    - `F4`: 削除 (確認フローあり)
    - `F5`: 保存 (追加・更新の確定)
    - `F12`: キャンセル (入力内容の破棄)

### データベース

- **テーブル**: `CARDDEMO.TRANSACTION_TYPE`
  - 参照 (`SELECT`)
  - 追加 (`INSERT`)
  - 更新 (`UPDATE`)
  - 削除 (`DELETE`)

### 呼び出し関係

- **Called By**:
  - `COTRTLIC` (一覧から選択時、または新規追加時)
- **Calls**:
  - `COTRTLIC` (処理完了後、またはキャンセル時に一覧へ戻る)
  - `COADM01C` (メニューへ戻る場合)

## 4. 主要ロジック

### 初期処理

- Commarea をチェックし、モードを判定。
  - キーが渡されている場合: DB から該当レコードを `SELECT` し、画面に表示 (`TTUP-SHOW-DETAILS`)。
  - キーがない場合: 新規追加モードとして画面をクリア。

### 入力検証 (`1200-EDIT-MAP-INPUTS`)

- 必須項目チェック (タイプコード、説明)。
- 変更有無のチェック (`1205-COMPARE-OLD-NEW`): DB 値と画面入力値を比較し、変更がなければ更新を行わない。

### DB更新処理

- **追加**: `10031-INSERT-DB` (詳細なセクション名はソース参照)
  - `INSERT INTO TRANSACTION_TYPE ...`
- **更新**: `9600-WRITE-PROCESSING` -> `UPDATE` 文発行
  - 事前にレコードロックまたは再取得による排他制御を考慮 (SQLCODE +100 ハンドリング等)。
- **削除**: `9800-DELETE-PROCESSING` -> `DELETE` 文発行
  - `F4` 押下で確認メッセージを表示し、再度の操作で実行。

### エラーハンドリング

- SQL エラー (重複キー、デッドロックなど) をハンドリングし、画面にメッセージを表示 (`WS-RETURN-MSG`)。
- 重大なエラー時は `ABEND` 処理へ。
