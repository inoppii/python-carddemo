# CBTRN03C 詳細設計書

## 1. 概要

`CBTRN03C` は、バッチ処理において取引マスタ (`TRANSACT-FILE`) から指定された期間の取引データを抽出し、カード（アカウント）ごとに集計したフォーマット済みレポートを作成するプログラムです。

## 2. プログラム情報

- **プログラム ID**: `CBTRN03C`
- **作成者**: AWS
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: `TRANREPT.jcl`

## 3. 入出力定義

### 3.1. 入力ファイル

- **TRANSACT-FILE**: 取引マスタ (Sequential)。処理対象の全取引データ。
- **DATE-PARMS-FILE**: 日付パラメータファイル (Sequential)。抽出開始日と終了日を指定。
- **XREF-FILE**: カード・アカウントクロスリファレンス (VSAM KSDS)。アカウント ID 取得用。
- **TRANTYPE-FILE**: 取引タイプマスタ (VSAM KSDS)。タイプ名称の取得用。
- **TRANCATG-FILE**: 取引カテゴリマスタ (VSAM KSDS)。カテゴリ名称の取得用。

### 3.2. 出力ファイル

- **REPORT-FILE**: 取引詳細レポート (Sequential)。133 バイト（プリンタ制御用 1 バイト含む）。

## 4. 処理ロジック詳細

### 4.1. パラメータ読込とフィルタリング

1. `DATE-PARMS-FILE` から `WS-START-DATE` と `WS-END-DATE` を読み込みます。
2. `TRANSACT-FILE` を順次読み込み、`TRAN-PROC-TS` (処理日時) が指定範囲内のもののみを抽出します。

### 4.2. 集計および報告処理

- **カード単位の集計**: カード番号が切り替わるタイミングで、そのカードに関連する取引金額の合計 (`WS-ACCOUNT-TOTAL`) を出力します。
- **改ページ制御**: 20 行ごとにページ合計 (`WS-PAGE-TOTAL`) を出力し、新しいページヘッダーを書き込みます。
- **最終集計**: ファイルの終端で、全体のグランド合計 (`WS-GRAND-TOTAL`) を出力します。

### 4.3. 名称解決 (`1500-A/B/C-LOOKUP`)

レポートを見やすくするため、コード値だけでなく以下のマスタから名称を取得して表示します。

- カード番号 → アカウント ID (`XREF-FILE`)
- 取引タイプコード → タイプ名称 (`TRANTYPE-FILE`)
- 取引カテゴリコード → カテゴリ名称 (`TRANCATG-FILE`)

## 5. エラーハンドリング

- 必須マスタファイルの読み込みに失敗 (`INVALID KEY`) した場合は、エラー内容を表示してプログラムをアベンド (`CEE3ABD`) させます。
- ファイルオープン/クローズエラーも同様にアベンド処理となります。

## 6. 特記事項

- 本プログラムは `SORT` ユーティリティでソート済みのデータを入力とすることを前提としています（`TRANREPT.jcl` を参照）。
- 133 バイトの固定長レコードとして出力されるため、メインフレーム等のシステムプリンタでの印刷に適した形式となっています。
