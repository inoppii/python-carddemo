# CBACT04C 詳細設計書

## 1. 概要

`CBACT04C` は、バッチ処理において各アカウントの取引カテゴリ別残高に基づき、月次の利息を計算して計上するプログラムです。計算された利息は新たな取引として取引マスタへ書き込まれ、アカウントマスタの残高に反映されます。

## 2. プログラム情報

- **プログラム ID**: `CBACT04C`
- **作成者**: AWS
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: `INTCALC.jcl`

## 3. 入出力定義

### 3.1. 入力ファイル

- **TCATBAL-FILE**: 取引カテゴリ別残高 (VSAM KSDS)。主入力。
- **XREF-FILE**: カード・アカウントクロスリファレンス (VSAM KSDS)。カード番号取得用。
- **DISCGRP-FILE**: 利息・手数料グループ定義 (VSAM KSDS)。利率の取得に使用。

### 3.2. 出力・更新ファイル

- **ACCOUNT-FILE**: アカウントマスタ (VSAM KSDS)。利息の反映とサイクル累計額のリセットを行う (I-O)。
- **TRANSACT-FILE**: 取引マスタ (Sequential/Output)。計算された利息を「System」取引として出力。

## 4. 処理ロジック詳細

### 4.1. 主処理ループ

`TCATBAL-FILE` をアカウント順（物理的な索引順）に読み込み、アカウントの切り替わりタイミングで集計結果を更新します。

### 4.2. 利息計算 (`1300-COMPUTE-INTEREST`)

1. **利率取得 (`1200-GET-INTEREST-RATE`)**: アカウントのグループ ID と取引カテゴリをキーに `DISCGRP-FILE` を検索し、利率 (`DIS-INT-RATE`) を取得します。見つからない場合は「DEFAULT」グループを使用します。
2. **計算式**:

   ```cobol
   COMPUTE WS-MONTHLY-INT = ( TRAN-CAT-BAL * DIS-INT-RATE ) / 1200
   ```

3. **加算**: 計算された月利をそのアカウントの合計利息 (`WS-TOTAL-INT`) に加算します。

### 4.3. 取引計上 (`1300-B-WRITE-TX`)

計算された利息レコードを `TRANSACT-FILE` に書き込みます。

- **取引タイプ**: `01` (利息/手数料等)
- **カテゴリ**: `05` (システム計上)
- **ソース**: `System`
- **説明**: `Int. for a/c [Account ID]`

### 4.4. アカウント更新 (`1050-UPDATE-ACCOUNT`)

アカウントの処理終了時に以下の更新を行います。

- **残高更新**: `ACCT-CURR-BAL` に合計利息を加算。
- **サイクルリセット**: `ACCT-CURR-CYC-CREDIT` および `ACCT-CURR-CYC-DEBIT` を 0 にリセットします。

## 5. エラーハンドリング

- ファイルオープン/読込エラー時はエラー詳細を表示してアベンド (`CEE3ABD`) します。
- 利率定義が見つからない（デフォルトも無い）場合は、利息 0 として処理を続行します。

## 6. 特記事項

- サイクル累計額のリセット機能が含まれているため、月締めのバッチ処理の一部として重要な役割を担います。
- 手数料計算 (`1400-COMPUTE-FEES`) は設計上のスロットが用意されていますが、現時点の実装は利息計算のみとなっています。
