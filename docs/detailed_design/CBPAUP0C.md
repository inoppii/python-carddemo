# CBPAUP0C 詳細設計書

## 1. 概要

`CBPAUP0C` は、設定された保存期間 (Expiry Days) を経過した「仮承認 (Pending Authorization)」データを IMS データベースから削除するバッチ処理プログラムです。期限切れのサマリーセグメント (`PAUTSUM0`) およびその配下の詳細セグメント (`PAUTDTL1`) を物理的に削除し、定期的なチェックポイント (`CHKP`) を発行して処理のコミットとリスタート性を確保します。

## 2. プログラム情報

- **プログラム ID**: `CBPAUP0C`
- **作成者**: AWS
- **タイプ**: COBOL Batch, IMS (DLI)
- **機能**: Delete Expired Pending Authorization Messages

## 3. 入出力定義

### 3.1. パラメータ (SYSIN)

- **形式**: 固定長テキスト (PRM-INFO 構造)
- **項目**:
  - `P-EXPIRY-DAYS` (2桁): 保存期間 (日数)。この日数を超えたデータが削除対象。
  - `P-CHKP-FREQ` (5桁): チェックポイント発行頻度 (処理件数単位)。
  - `P-CHKP-DIS-FREQ` (5桁): 進捗表示頻度 (現在はロジック上は使用されているが、表示頻度制御用)。
  - `P-DEBUG-FLAG` (1桁): デバッグ出力フラグ ('Y'/'N')。

### 3.2. IMS データベース

- **PSB**: `PSBPAUTB`
- **セグメント**:
  - `PAUTSUM0` (ルート): アカウント単位の承認サマリー。
  - `PAUTDTL1` (子供): 個別の承認明細。タイムスタンプ (`PAUT9CTS`) を保持。

### 3.3. 出力レポート (SYSOUT / Display)

- 処理開始・終了メッセージ
- パラメータ確認内容
- 削除したサマリー件数 (`WS-NO-SUMRY-DELETED`)
- 削除した明細件数 (`WS-NO-DTL-DELETED`)
- 読み込んだ件数など

## 4. 処理ロジック詳細

### 4.1. 初期化処理 (1000-INITIALIZE)

1. `ACCEPT ... FROM SYSIN` でパラメータ読み込み。
   - 保存期間 (`WS-EXPIRY-DAYS`)、チェックポイント頻度 (`WS-CHKP-FREQ`) を設定。
2. 現在日付を取得し、基準日 (`WS-AUTH-DATE`) を計算。
   - `基準日 = 現在日付 - 保存期間` (日付減算ロジックを含む)。
   - この基準日より *古い* 更新日を持つレコードが削除対象となる。

### 4.2. メインループ (2000-PROCESS-AUTH-Records)

IMS データベースを順次読み込み、全件走査を行う。

1. **ルートセグメント読み込み (`GN` Call)**:
   - `DLI GN` で `PAUTSUM0` を順次取得 (Get Next)。
   - データベース終了 (`GB`) でループ終了。
2. **削除判定**:
   - 取得したサマリーの更新日付 (`PA-AUTH-DATE-9C`) と基準日 (`WS-AUTH-DATE`) を比較。
   - `更新日 < 基準日` の場合、削除対象と判断。
3. **明細読み込みと削除 (3000-DELETE-AUTH-DTL)**:
   - ルートが削除対象の場合、その配下の削除も検討するが、IMS の場合、**親セグメントを削除(`DLET`)すれば配下の子セグメントも自動的に削除される**。
   - プログラム上は、論理的な整合性確認やログ出力のために明細 (`PAUTDTL1`) を読み込んでいる場合があるが、最終的な削除アクションはルートに対する `DLI DLET` で一括して行われるのが一般的である。
   - *コード上の実装*: このプログラムでは明細レベルでの精査を行っているか確認が必要だが、基本的には「期限切れのアカウント」を一括削除する挙動に見える。
4. **削除実行**:
   - `DLI DLET` コマンドで現在のセグメント (ルート) を削除。
5. **チェックポイント処理 (CHECKPOINT-RTN)**:
   - 処理カウンター (`WS-NO-CHKP`) をインクリメント。
   - 指定された頻度 (`WS-CHKP-FREQ`) に達したら、`DLI CHKP` を発行。
   - これにより、ここまでの削除をコミットし、IMS ログにチェックポイントID (`WK-CHKPT-ID`) を記録。

### 4.3. 終了処理 (4000-TERMINATE)

- 処理結果統計 (削除件数等) を表示。
- バッチ処理を終了 (`GOBACK`)。

## 5. エラーハンドリング

- **IMS エラー**: DLI コール後のステータス (`DIBSTAT`) をチェック。
- **異常終了**: 想定外のステータスコードの場合、エラーメッセージを出力して `9999-ABEND` (Return Code 16) で異常終了する。

## 6. 特記事項

- **日付計算**: 単純な減算だけでなく、年跨ぎ等を考慮した日付計算ロジック (`COMPUTE-DATE-RTN`) が実装されている必要がある (COBOL の日付計算は自前で行うことが多い)。
- **パフォーマンス**: 大量データ削除時はチェックポイント頻度の調整が重要。頻度が低すぎるとロック保持時間が長くなり、高すぎるとオーバーヘッドが増える。
