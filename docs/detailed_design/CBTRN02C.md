# CBTRN02C 詳細設計書

## 1. 概要

`CBTRN02C` は、バッチ処理において日次の取引データ (`DALYTRAN`) を読み込み、バリデーションを行った上で取引マスタ (`TRANSACT`) へ反映するプログラムです。同時に、アカウント残高 (`ACCTDAT`) の更新およびカテゴリ別集計ファイル (`TCATBALF`) の更新も行います。

## 2. プログラム情報

- **プログラム ID**: `CBTRN02C`
- **作成者**: AWS
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: `POSTTRAN.jcl`

## 3. 入出力定義

### 3.1. 入力ファイル

- **DALYTRAN**: 日次取引ファイル (Sequential)。1件 350 バイト。
- **XREFFILE**: カード・アカウントクロスリファレンス (VSAM KSDS)。カード番号からアカウント ID を引くために使用。

### 3.2. 出力・更新ファイル

- **TRANSACT**: 取引マスタ (VSAM KSDS)。有効な取引を書き込む (Output)。
- **DALYREJS**: リジェクトファイル (Sequential)。エラーとなった取引を格納。末尾にエラー理由 (Trailer) が付与される。
- **ACCTFILE**: アカウントマスタ (VSAM KSDS)。残高およびサイクル累計額を更新 (I-O)。
- **TCATBALF**: 取引カテゴリ別残高 (VSAM KSDS)。アカウント、タイプ、カテゴリ単位の集計額を更新 (I-O)。

## 4. 処理ロジック詳細

### 4.1. バリデーション (`1500-VALIDATE-TRAN`)

取引データに対して以下のチェックを実施し、NG の場合は `DALYREJS` へ出力します。

1. **カード存在チェック**: `DALYTRAN-CARD-NUM` が `XREFFILE` に存在すること。
2. **アカウント存在チェック**: クロスリファレンスから得たアカウント ID が `ACCTFILE` に存在すること。
3. **限度額チェック**: 取引金額加算後の残高が `ACCT-CREDIT-LIMIT` を超えないこと。
4. **期限チェック**: 取引発生日がアカウントの有効期限内であること。

### 4.2. 取引反映処理 (`2000-POST-TRANSACTION`)

バリデーション OK の場合、以下の 3 つの更新を同一トランザクション（バッチ単位）で実行します。

1. **カテゴリ別集計更新 (`2700-UPDATE-TCATBAL`)**:
    - 該当キー（アカウント+タイプ+カテゴリ）のレコードを `READ`。
    - 存在すれば `REWRITE` で加算、存在しなければ `WRITE` で新規作成。
2. **アカウント残高更新 (`2800-UPDATE-ACCOUNT-REC`)**:
    - `ACCT-CURR-BAL` に対し取引金額を加算。
    - 金額の正負に応じ、`ACCT-CURR-CYC-CREDIT` または `DEBIT` も更新。
3. **取引マスタ書き込み (`2900-WRITE-TRANSACTION-FILE`)**:
    - 現在時刻を DB2 形式のタイムスタンプとしてセットし、`TRANSACT` へ新規 `WRITE`。

## 5. エラーハンドリング

- ファイルオープン/入出力エラー発生時は、エラー詳細を `DISPLAY` してプログラムをアベンド (`CEE3ABD`) させます。
- バリデーションエラー時はアベンドさせず、リジェクトレコードとしてカウントし処理を続行します。最終的にリジェクトが 1 件以上あれば `RETURN-CODE = 4` で終了します。

## 6. 特記事項

- `POSTTRAN.jcl` 内の `STEP15` で実行されます。
- 集計ファイル (`TCATBALF`) の動的なレコード作成（Upsert ロジック）を備えています。
