# CBTRN01C 詳細設計書

## 1. 概要

`CBTRN01C` は、バッチ処理において日次の取引データ (`DALYTRAN`) を読み込み、関連するマスタファイル（カード、アカウント、顧客）との整合性を確認するためのプログラムです。実際のファイル更新は行わず、データの妥当性を `DISPLAY` (標準出力) で報告することを主な目的としています。

## 2. プログラム情報

- **プログラム ID**: `CBTRN01C`
- **作成者**: AWS
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: (個別実行または検証用ステップ。`CBTRN02C` の前行程として利用可能)

## 3. 入出力定義

### 3.1. 入力ファイル

- **DALYTRAN**: 日次取引ファイル (Sequential)。
- **CUSTOMER-FILE**: 顧客マスタ (VSAM KSDS)。
- **XREF-FILE**: カード・アカウントクロスリファレンス (VSAM KSDS)。
- **CARD-FILE**: カードマスタ (VSAM KSDS)。
- **ACCOUNT-FILE**: アカウントマスタ (VSAM KSDS)。
- **TRANSACT-FILE**: 取引マスタ (VSAM KSDS)。

### 3.2. 出力

- **SYSOUT (標準出力)**: 処理結果、読込レコードの内容、およびエラーメッセージ。

## 4. 処理ロジック詳細

### 4.1. 主ループ (`MAIN-PARA`)

日次取引ファイルの終端まで以下の処理を繰り返します。

1. **取引レコード取得**: `DALYTRAN` から次レコードを読み込む。
2. **クロスリファレンス確認**: 取引レコード内のカード番号をキーに `XREF-FILE` を検索。
    - 見つかった場合: アカウント ID を取得。
    - 見つからない場合: 「CARD NUMBER ... COULD NOT BE VERIFIED」を表示してスキップ。
3. **アカウント存在確認**: 得られたアカウント ID をキーに `ACCOUNT-FILE` を検索。
    - 見つからない場合: 「ACCOUNT ... NOT FOUND」を表示。

### 4.2. ファイル操作 (`0000-OPEN` 〜 `9500-CLOSE`)

処理の開始時にすべての入力ファイルを `OPEN INPUT` し、終了時に `CLOSE` します。更新を行う `I-O` や `OUTPUT` モードは使用していません。

## 5. エラーハンドリング

- ファイルオープン失敗時、または読み込み中に重大な入出力エラー (`DALYTRAN-STATUS` 等) が発生した場合は、エラーメッセージを表示してアベンド (`CEE3ABD`) します。
- マスタ不在などの論理エラーは `DISPLAY` による報告に留め、プログラム自体は正常終了させます。

## 6. 特記事項

- `CBTRN02C` (反映処理) を実行する前のデータクレンジングや整合性調査に使用される補助的なプログラムです。
- 全マスタファイル (`CUST`, `CARD`, `ACCT`, `XREF`, `TRANS`) を参照しており、取引データがどのマスタと紐付いているかを網羅的に確認できる構成になっています。
