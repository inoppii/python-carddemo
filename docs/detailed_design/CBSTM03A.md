# CBSTM03A 詳細設計書

## 1. 概要

`CBSTM03A` は、各アカウントの基本情報、顧客情報、および取引履歴を統合して、月次の利用明細書（ステートメント）を生成するプログラムです。出力形式として、標準テキスト形式と HTML 形式の 2 種類を同時に作成します。

## 2. プログラム情報

- **プログラム ID**: `CBSTM03A`
- **作成者**: AWS
- **タイプ**: BATCH COBOL Program
- **関連 JCL**: `STMTGEN.jcl`
- **関連サブルーチン**: `CBSTM03B` (File I/O 担当)

## 3. 入出力定義

### 3.1. ファイル構成（`CBSTM03B` 経由）

- **XREFFILE**: クロスリファレンスマスタ。全アカウントの走査に使用。
- **CUSTFILE**: 顧客マスタ。氏名、住所情報の取得。
- **ACCTFILE**: アカウントマスタ。残高、FICO スコアの取得。
- **TRNXFILE**: 取引履歴ファイル。当月の取引明細の取得。

### 3.2. 直接出力ファイル

- **STMT-FILE**: テキスト形式ステートメント (Sequential, 80 bytes)。
- **HTML-FILE**: HTML 形式ステートメント (Sequential, 100 bytes)。

## 4. 処理ロジック詳細

### 4.1. I/O 抽象化

本プログラムは直接マスタファイルを `OPEN/READ` せず、サブルーチン `CBSTM03B` を介してデータアクセスを行います。これにより、業務ロジックとデータアクセス層が分離されています。

### 4.2. ステートメント生成フロー

1. `XREFFILE` から次のアカウントを取得します。
2. 取得した `CUST-ID` および `ACCT-ID` をキーに、顧客情報とアカウント情報を取得します。
3. `TRNXFILE` から該当アカウントの取引履歴を抽出し、内部テーブル (`WS-TRNX-TABLE`) に格納します。
4. 収集した情報を元に、以下の出力処理を行います。
   - **テキスト出力**: ヘッダー、顧客情報、口座概況、取引明細、フッターの順に 80 桁形式で書き込み。
   - **HTML 出力**: HTML/CSS タグを付与した形式で書き込み。埋め込みスタイルシートにより、ウェブブラウザで閲覧可能な整形済みデザインを生成します。

### 4.3. 特徴的な実装

- **レガシー制御構造**: `ALTER` 文および `GO TO` 文が使用されており、メインフレームからの移行資産としての側面を強く残しています。
- **低レベル情報の取得**: `PSA`, `TCB`, `TIOT` といったメインフレームの制御ブロックをポインタで参照し、実行中の JCL 名やステップ名を取得・表示します。

## 5. エラーハンドリング

- `CBSTM03B` からの戻り値 (`WS-M03B-RC`) をチェックし、`00` (正常) または `10` (EOF) 以外の場合は、エラーメッセージを表示してアベンド処理 (`9999-ABEND-PROGRAM`) を行います。

## 6. 特記事項

- HTML 出力機能により、バッチ処理結果をそのまま顧客向けのウェブポータル等で活用可能な形式で提供できる設計になっています。
- 取引明細の最大格納数は、内部テーブルの定義により 1 アカウントあたり 10 件程度に制限されている可能性があるため、大量取引がある場合の挙動には注意が必要です。
