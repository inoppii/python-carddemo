# COCRDUPC 詳細設計書

## 1. 概要

`COCRDUPC` は、クレジットカード情報の詳細を表示し、更新を行う CICS オンラインプログラムです。
`COCRDSLC` (参照) と同様の表示機能に加え、カード名義、有効期限、ステータスなどのフィールドを更新する機能を持ちます。データの整合性を保つための楽観的ロック制御が実装されています。

## 2. プログラム情報

- **プログラム ID**: `COCRDUPC`
- **作成者**: AWS
- **タイプ**: CICS COBOL, VSAM, BMS
- **トランザクション ID**: `CCUP`
- **マップセット**: `COCRDUP`
- **マップ名**: `CCRDUPA`

## 3. 入出力定義

### 3.1. 画面 (BMS)

- **マップセット**: `COCRDUP`
- **主要フィールド**:
  - **キー項目 (表示のみ)**: `ACCTSIDI` (Account ID), `CARDSIDI` (Card Number)。
  - **更新可能項目**:
    - `CRDNAME`: カード名義 (Name Embossed)。
    - `CRDSTCD`: ステータス (Active Status - Y/N)。
    - `EXPMON` / `EXPYEAR`: 有効期限。

### 3.2. VSAM ファイル

- **CARDDAT**: 更新対象のマスターファイル。`READ UPDATE` で排他制御を行う。
- **CARDAIX**: 検索用パス (Alternate Index)。

### 3.3. COMMAREA

- **更新制御用**:
  - `CCUP-OLD-DETAILS`: 画面表示時点でのデータスナップショット。
  - `CCUP-NEW-DETAILS`: 画面から入力された新しいデータ。
  - `CCUP-CHANGE-ACTION`: ステータスフラグ (詳細は不問、変更検知などで使用)。

## 4. 処理ロジック詳細

### 4.1. データ取得と初期表示 (Search Phase)

- アカウント ID とカード番号をキーに `CARDDAT` を検索。
- 取得したデータを画面に表示すると同時に、`CCUP-OLD-DETAILS` にディープコピーを作成して保存（後の変更比較用）。

### 4.2. 入力検証 (Validation Phase)

- ユーザーが更新ボタン (F5 等) または Enter を押下した際、入力値を検証。
- **バリデーション**:
  - 日付の妥当性 (月は 01-12, 年は適切か)。
  - ステータスコード (Y/N のみ)。
  - 名義人 (アルファベットのみ等のチェック)。

### 4.3. 変更検知 (Change Detection)

- 画面入力値 (`CCUP-NEW`) と保存済みデータ (`CCUP-OLD`) を全フィールド比較。
- 差異がなければ「No change detected」と表示し、更新スキップ。

### 4.4. 更新処理 (Update Phase)

1. **再読み込みとロック (`READ FOR UPDATE`)**:
   - 更新直前に `CARDDAT` を `UPDATE` オプション付きで再読み込み。
2. **楽観的ロックチェック**:
   - 再読み込みしたデータの値が、`CCUP-OLD-DETAILS` (初期表示時の値) と一致するか確認。
   - 不一致の場合、他のユーザーが更新したと判断し、「Record changed by some one else」エラーを表示して処理中断。
3. **書き込み (`REWRITE`)**:
   - ロックチェックを通過した場合のみ、新しい値でレコードを更新。

## 5. エラーハンドリング

- **同時更新競合**: 上記の楽観的ロックにより検知。
- **レコードロック**: `READ UPDATE` 時に他がロック中の場合の待機またはエラー。
- **一般的エラー**: VSAM I/O エラー、BMS マップエラー等。

## 6. 特記事項

- **楽観的ロックの実装**: CICS のトランザクション境界を跨ぐ（画面表示 -> 入力待ち -> 更新実行）処理において、データの整合性を担保するための標準的な手法が採用されている。
